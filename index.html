import sys
import sqlite3
from datetime import datetime
from PyQt5 import QtWidgets, QtCore, QtGui

# ===== Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
def init_db():
    conn = sqlite3.connect("tickets.db")
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS tickets (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    ticket_number TEXT UNIQUE,
                    account_name TEXT,
                    platform TEXT,
                    open_date TEXT,
                    open_time TEXT,
                    close_time TEXT,
                    reminder_6h TEXT,
                    reminder_24h TEXT,
                    reminder_48h TEXT,
                    close_reason TEXT,
                    agent TEXT
                )''')
    conn.commit()
    conn.close()

# ===== ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
class LoginWindow(QtWidgets.QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("HM Follow Up - Login")
        self.setGeometry(500, 200, 500, 350)

        # ØªØ¹ÙŠÙŠÙ† Ø®Ù„ÙÙŠØ©
        self.setAutoFillBackground(True)
        palette = self.palette()
        palette.setBrush(self.backgroundRole(), QtGui.QBrush(QtGui.QPixmap("bg.jpg")))
        self.setPalette(palette)

        layout = QtWidgets.QVBoxLayout()

        # Ø´Ø¹Ø§Ø±
        logo = QtWidgets.QLabel()
        logo.setPixmap(QtGui.QPixmap("logo.png").scaled(120, 120, QtCore.Qt.KeepAspectRatio))
        logo.setAlignment(QtCore.Qt.AlignCenter)
        layout.addWidget(logo)

        # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        self.user_input = QtWidgets.QLineEdit()
        self.user_input.setPlaceholderText("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Username")
        self.user_input.setStyleSheet("padding:8px; font-size:14px;")
        layout.addWidget(self.user_input)

        self.pass_input = QtWidgets.QLineEdit()
        self.pass_input.setPlaceholderText("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Password")
        self.pass_input.setEchoMode(QtWidgets.QLineEdit.Password)
        self.pass_input.setStyleSheet("padding:8px; font-size:14px;")
        layout.addWidget(self.pass_input)

        self.login_btn = QtWidgets.QPushButton("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Login")
        self.login_btn.setStyleSheet("background-color:#2E8B57; color:white; padding:10px; font-size:14px;")
        self.login_btn.clicked.connect(self.check_login)
        layout.addWidget(self.login_btn)

        self.setLayout(layout)

    def check_login(self):
        user = self.user_input.text()
        password = self.pass_input.text()

        if user == "Abdullah" and password == "A":
            self.main = MainWindow(user)
            self.main.show()
            self.close()
        else:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")

# ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ°Ø§ÙƒØ± =====
class MainWindow(QtWidgets.QWidget):
    def __init__(self, agent):
        super().__init__()
        self.agent = agent
        self.setWindowTitle("HM Follow Up - Dashboard")
        self.setGeometry(200, 100, 950, 550)
        self.setStyleSheet("background-color:#f4f4f4; font-size:13px;")

        layout = QtWidgets.QVBoxLayout()

        # Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù…Ù„ÙˆÙ†
        header = QtWidgets.QLabel("ğŸ“‹ Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ°Ø§ÙƒØ± - HM Follow Up")
        header.setAlignment(QtCore.Qt.AlignCenter)
        header.setStyleSheet("background-color:#2E8B57; color:white; padding:10px; font-size:16px; font-weight:bold;")
        layout.addWidget(header)

        # Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        stats_layout = QtWidgets.QHBoxLayout()
        self.total_label = QtWidgets.QLabel("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±: 0")
        self.open_label = QtWidgets.QLabel("Ø§Ù„Ù…ÙØªÙˆØ­Ø©: 0")
        self.closed_label = QtWidgets.QLabel("Ø§Ù„Ù…ØºÙ„Ù‚Ø©: 0")
        for lbl in [self.total_label, self.open_label, self.closed_label]:
            lbl.setStyleSheet("background:#fff; border:1px solid #ccc; padding:8px;")
        stats_layout.addWidget(self.total_label)
        stats_layout.addWidget(self.open_label)
        stats_layout.addWidget(self.closed_label)
        layout.addLayout(stats_layout)

        # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©
        form_layout = QtWidgets.QFormLayout()
        self.ticket_number = QtWidgets.QLineEdit()
        self.account_name = QtWidgets.QLineEdit()
        self.platform = QtWidgets.QComboBox()
        self.platform.addItems(["X", "Instagram", "Email", "Phone Call"])
        self.open_date = QtWidgets.QDateEdit(QtCore.QDate.currentDate())
        self.open_date.setCalendarPopup(True)
        self.open_time = QtWidgets.QTimeEdit(QtCore.QTime.currentTime())
        self.close_time = QtWidgets.QTimeEdit()
        self.rem6 = QtWidgets.QCheckBox("Ø¨Ø¹Ø¯ 6 Ø³Ø§Ø¹Ø§Øª")
        self.rem24 = QtWidgets.QCheckBox("Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©")
        self.rem48 = QtWidgets.QCheckBox("Ø¨Ø¹Ø¯ 48 Ø³Ø§Ø¹Ø©")
        self.close_reason = QtWidgets.QComboBox()
        self.close_reason.addItems([
            "", "Ø£ÙØºÙ„Ù‚Øª Ø¨Ø¯ÙˆÙ† ØªØ°ÙƒÙŠØ±", 
            "Ø£ÙØºÙ„Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø£ÙˆÙ„",
            "Ø£ÙØºÙ„Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø«Ø§Ù†ÙŠ",
            "Ø£ÙØºÙ„Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø«Ø§Ù„Ø«",
            "Ø£ÙØºÙ„Ù‚Øª Ù„Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯"
        ])

        form_layout.addRow("Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©:", self.ticket_number)
        form_layout.addRow("Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:", self.account_name)
        form_layout.addRow("Ø§Ù„Ù…Ù†ØµØ©:", self.platform)
        form_layout.addRow("ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­:", self.open_date)
        form_layout.addRow("ÙˆÙ‚Øª Ø§Ù„ÙØªØ­:", self.open_time)
        form_layout.addRow("ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:", self.close_time)
        form_layout.addRow("ØªØ°ÙƒÙŠØ±:", self.rem6)
        form_layout.addRow("", self.rem24)
        form_layout.addRow("", self.rem48)
        form_layout.addRow("Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:", self.close_reason)

        layout.addLayout(form_layout)

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btn_layout = QtWidgets.QHBoxLayout()
        self.save_btn = QtWidgets.QPushButton("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒØ±Ø©")
        self.save_btn.setStyleSheet("background-color:#2E8B57; color:white; padding:8px;")
        self.save_btn.clicked.connect(self.save_ticket)
        self.search_btn = QtWidgets.QPushButton("ğŸ” Ø¨Ø­Ø« Ø¹Ù† ØªØ°ÙƒØ±Ø©")
        self.search_btn.setStyleSheet("background-color:#4682B4; color:white; padding:8px;")
        self.search_btn.clicked.connect(self.search_ticket)
        btn_layout.addWidget(self.save_btn)
        btn_layout.addWidget(self.search_btn)
        layout.addLayout(btn_layout)

        self.setLayout(layout)
        self.update_stats()

    def save_ticket(self):
        conn = sqlite3.connect("tickets.db")
        c = conn.cursor()
        try:
            c.execute("INSERT INTO tickets (ticket_number, account_name, platform, open_date, open_time, close_time, reminder_6h, reminder_24h, reminder_48h, close_reason, agent) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", (
                self.ticket_number.text(),
                self.account_name.text(),
                self.platform.currentText(),
                self.open_date.date().toString("yyyy-MM-dd"),
                self.open_time.time().toString("HH:mm:ss"),
                self.close_time.time().toString("HH:mm:ss"),
                "âœ…" if self.rem6.isChecked() else "âŒ",
                "âœ…" if self.rem24.isChecked() else "âŒ",
                "âœ…" if self.rem48.isChecked() else "âŒ",
                self.close_reason.currentText(),
                self.agent
            ))
            conn.commit()
            QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…")
            self.update_stats()
        except sqlite3.IntegrityError:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "âš ï¸ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§")
        conn.close()

    def search_ticket(self):
        ticket_id, ok = QtWidgets.QInputDialog.getText(self, "Ø¨Ø­Ø«", "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©:")
        if ok and ticket_id:
            conn = sqlite3.connect("tickets.db")
            c = conn.cursor()
            c.execute("SELECT * FROM tickets WHERE ticket_number=?", (ticket_id,))
            ticket = c.fetchone()
            conn.close()
            if ticket:
                QtWidgets.QMessageBox.information(self, "Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«", f"Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: {ticket[1]}\nØ§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: {ticket[2]}\nØ§Ù„Ù…Ù†ØµØ©: {ticket[3]}\nØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­: {ticket[4]}\nğŸ‘¤ Ø£Ø¶ÙŠÙØª Ø¨ÙˆØ§Ø³Ø·Ø©: {ticket[11]}")
            else:
                QtWidgets.QMessageBox.warning(self, "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ°ÙƒØ±Ø©")

    def update_stats(self):
        conn = sqlite3.connect("tickets.db")
        c = conn.cursor()
        c.execute("SELECT COUNT(*) FROM tickets")
        total = c.fetchone()[0]
        c.execute("SELECT COUNT(*) FROM tickets WHERE close_time='' OR close_time IS NULL")
        open_tickets = c.fetchone()[0]
        closed_tickets = total - open_tickets
        conn.close()
        self.total_label.setText(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±: {total}")
        self.open_label.setText(f"Ø§Ù„Ù…ÙØªÙˆØ­Ø©: {open_tickets}")
        self.closed_label.setText(f"Ø§Ù„Ù…ØºÙ„Ù‚Ø©: {closed_tickets}")

# ===== ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
if __name__ == "__main__":
    init_db()
    app = QtWidgets.QApplication(sys.argv)
    win = LoginWindow()
    win.show()
    sys.exit(app.exec_())